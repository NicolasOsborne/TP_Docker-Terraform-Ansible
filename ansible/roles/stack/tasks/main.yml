- name: Create directories for config and certs
  file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
  loop:
    - /tmp/docker/nginx/conf.d
    - /tmp/docker/nginx/certs

- name: Copy Nginx config
  copy:
    src: '{{ playbook_dir }}/../docker/nginx/conf.d/default.conf'
    dest: /tmp/docker/nginx/conf.d/default.conf

- name: Generate Self-Signed SSL Certs (Let's Encrypt Fallback)
  command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout /tmp/docker/nginx/certs/privkey.pem
    -out /tmp/docker/nginx/certs/fullchain.pem
    -subj "/CN=glpi.local"
  args:
    creates: /tmp/docker/nginx/certs/fullchain.pem

- name: Create Docker secrets
  shell: |
    docker secret inspect {{ item.name }} >/dev/null 2>&1 || \
    echo "{{ item.value }}" | docker secret create {{ item.name }} -
  loop:
    - { name: 'db_password', value: 'glpi' }
    - { name: 'db_root_password', value: 'root' }

- name: Deploy or Update Stack
  command: docker stack deploy -c {{ playbook_dir }}/../docker/docker-stack.yml tp_devops
